#MongoDB Deployment Planner

An online tool that helps engineering teams organize and plan their MongoDB projects

##Overview

Engineering teams plan for production by writing proper specs and requirements. These specs serve as a "DevOps contract" where both teams agree on what load the database will serve and how  it will be configured.

Deployments MongoDB can and should be described with standard documentation including all requirements and specifications such that:

- Dev and Ops have a clear understanding of expected load
- Clusters can be provisioned and configured appropriately
- Operation Constraints can be defined, (e.g. constrained queries)
- Failure protection can be defined, (circuit breakers, bulkheads, and timeouts)

###The MongoDB Deployment Planner
Is an online form which users can create their own DevOps contract by creating a list of all operations the database is to serve. DevOps teams can qualify and quantify these operations in a helpful and easy to use online template which will generate 4 documents:

- Database Access Requirements (DAR)
- Database Access Specifications (DAS)
- Cluster Configuration Specifications
- Monitoring and Alerting Specification

Click [here]() to view a sketch implementation of the DAS template.

[ScavengerHunt](https://github.com/breinero/ScavengerHunt) is an example applicaiton  which implments the DAR/DAS best practices described in this project. You can examine that project's DevOps contract [here](https://github.com/breinero/ScavengerHunt/tree/master/specifications).

###Database Access Requirements Document
A complete list of all operations, (queries, commands, aggregations) sent by the application client to the database with sufficient detail such that the Operations Team can declare required indexes, allocate necessary hardware and provision a cluster to meet current and expected loads.

Each line item describes an individual operation, which can be identified by name and type, [query|insert|update|command]. A operation descriptor is composed of a set of operation specific fields relevant to the operation type 

####Operation Descriptor

- Operation Name: "Update User “Shopping Cart”
- Relevant Schema Descriptor
- Operation Type [read|insert|update|delete|aggregate]
- Query Predicates
- Expected Result Set Size
- Projected fields: [ 'hotOrNotRating', 'toga size' ]
- Service Level Agreement, (SLA)
- Frequency of Operation
- Required Durability (Write ops only)
- Required Availability
- Consistency Tolerance (Read ops only)
- Growth expectations

###Database Access Specification Document

Details all parameters the application client is required include when issuing requests to the database on a per-operation basis. This document shall include an entry for each individual operation defined in the Access Declaration Document. This document is generated by The Operations Team as a response to the Database Operations Requirement Specifications.

####Operation Descriptor
- Operation Name
- Namespace: <database.collection>
- Authentication / Authorization Credenitals
- Consistency: Read Preference (Reads only)
- Durability; i.e. Write concern (writes only) 
[ [0-N] | 'majority' ]
journal: false
fsync: false
tags { <tagname:min>, ... }
GetLastErrorMode: "name"
- Operation time outs

###Cluster Configuration Document  

A comprehensive description of the MongoDB cluster, including node composition, locations, configuration parameters, hardware specifications, tags and index declarations for each node in the cluster. 

####Cluster Configuration

#####Configuration at the Sharded Cluster Level
- Shard namespaces
- Shard Keys
- Shard tags
- Balancer windows
- Primary Shards

#####Configuration at the Replica Set Level
- Topology & Geographic locations
- Tags
- Priorities
- Hidden Nodes
- Delayed Secondaries
- Index declarations
	* per replica set
	* per node
- Authentication and Authorization
- Backups & Recovery Protocols
- 	Maintenance Routines

###Monitoring and Alerting Specification

This document describes the specific monitoring metrics with alerting thresholds required for the production cluster.
####Metrics
#####opcounters
Number of queries, updates, inserts, deletes, getmore and (other) commands per second. Gives basic overview of what the system is doing.
#####getmore
In opcounters graph, the getmore opcounter can sometimes point to unnecessarily large result sets.
#####memory
In the memory graph, focus on *resident memory* to know how much memory MongoDB has consumed.
#####page faults
This is the primary metric to know whether the working data set fits in RAM or not. When data has to be fetched from disk, it generates a page fault.
#####lock %
How often the server is blocked by the write lock. This should be as close to 0 as possible, but on a write heavy system values from 20% to 50% are still manageable.
#####queues
Number of operations that are blocked and waiting for the lock. Even if lock percentage is high, if there are no other operations blocked, there's no reason for concern.
#####replication lag
This is the minimum time for a write to be replicated to secondary node. Excessive replication lag diminishes the worth of failover nodes and adversely effects the latency for write operations using a write concern of w > 1.
#####oplog window
This is the amount of time in write operations which the oplog covers, this window represents how long a replicating secondary can be down before loosing it's ability to catch up to the primary. This should not be allowed to drop below 24 hours.
#####Threshold
Less than 48 hours
#####background flush average
Mongod applies all writes in memory first, flushing writes to disk in the background. Excessive flush times indicate an IO bottleneck.
